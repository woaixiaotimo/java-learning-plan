



# spring cloud eureka简介

spring cloud eureka 是spring cloud netflix 微服务套件中的一部分，它基于netflix eureka 做了二次封装，主要完成微服务框架中的服务治理功能。

spring cloud eureka 使用 spring cloud netflix 来实现服务注册与发现，它既包含了服务端组件，也包含了客户端组件，并且服务端和客户端均使用java编写。由于eureka服务端使用reseful api进行通信，所以它也将支持非java语言的微服务应用，如.net平台的Steeltoe、nodejs的 eureka-js-client等

## eureka 服务端

eureka 服务端也称之为注册中心。它同其他注册中心一样同样支持高可用配置。如果eureka以集群方式部署，当集群中有分片 故障出现时，那么eureka将转入自我保护模式。它允许在分片故障期间继续提供服务发现与注册，当故障分片恢复运行时，集群中的其他分片就会把他们的状态再次同步回来。netflix推荐每个可用的区域运行一个eureka服务端，通过它来形成集群。不同的可用区域的服务注册中心通过异步模式相互复制各自的状态，这意味着任意给定的试讲点每个个例关于所有服务的状态是有细微差别的。

## eureka 客户端

主要处理服务的注册与发现。客户端通过注解和参数配置的方式，嵌入客户端应用程序代码中，在程序运行过程中，向服务端注册中心注册自身，并周期性的发送心跳来更新它的服务租约。同时它也能从服务端查询当前注册的服务并将其缓存到本地，并周期性的刷新服务状态。


# 服务治理

服务治理可以说是微服务架构中最核心和基础的模块，他主要来实现各个微服务的自动化注册和发现。


## 服务注册

在服务治理框架中，通常会构建一个注册中心，每个服务单元像注册中心登记紫的提供的服务，将主机的端口号，版本号，通信协议等一些附加信息告知注册中心，注册中心将按照服务名称进行分类，并创建服务清单。

另外服务中心还需要以心跳的方式去检测，清单中的服务是否可用，如果不可用需要从服务中剔除，已达到排除故障服务的效果。

## 服务发现

由于在服务治理的框架下运作，服务间的调用将不再通过实例地址进行访问，而是通过服务名发起请求调用来实现。当调用方在调用服务提供的请求时并不知道被调用方的地址。因此需要向注册中心进行咨询，并获取所有服务的实例清单，以实现堆具体实例的访问。(以后或说明负载均衡和服务剔除的策略)



# 搭建服务注册中心

1. 首先创建一个springboot工程并引入下面的依赖

    ```
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
    ```

2. 通过@EnableEurekaServer启动一个服务注册中心

    ```
    @EnableEurekaServer
    @SpringBootApplication
    public class ServerEurekaApplication {
        public static void main(String[] args) {
            SpringApplication.run(ServerEurekaApplication.class, args);
        }
    }
    ```

3. 在application.properties中配置

    在默认设置下，改服务注册中心也会将自己作为客户端来尝试注册它自己，所以我们需要禁用它的客户端注册行为

    ```
    #设置tomcat服务端口号
    server.port=1111
    #设置服务名称
    spring.application.name=server-eureka

    eureka.instance.hostname=localhost
    #注册中心不需要注册自己
    eureka.client.register-with-eureka=false
    #注册中心不需要去发现服务
    eureka.client.fetch-registry=false
    #设置服务注册中心的URL
    eureka.client.serviceUrl.defaultZone=http://${eureka.instance.hostname}:${server.port}/eureka
    ```
在完成上面的配置后，启动程序并在浏览器中访问http://127.0.0.1:1111/

![](https://raw.githubusercontent.com/woaixiaotimo/img/master/20181207153649.png)

可以看到Instance currently registered with eureka 一栏是空的，说明该注册中心还没有注册任何服务

# 注册服务提供者

1. 首先创建一个springboot工程并引入下面的依赖


    ```
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    ```
2. 通过@EnableEurekaClient启动一个服务提供者

    ```
    @EnableEurekaClient
    @SpringBootApplication
    public class ServiceMemberApplication {
        public static void main(String[] args) {
            SpringApplication.run(ServiceMemberApplication.class, args);
        }
    }
    ```

3. 在application.properties中配置

    ```
    server.port=8080
    #设置服务名
    spring.application.name=service-member
    #设置服务注册中心的URL，本服务要向该服务注册中心注册自己
    eureka.client.serviceUrl.defaultZone=http://127.0.0.1:1111/eureka
    ```

启动程序即可发现服务已经注册到注册中心上了

![](https://raw.githubusercontent.com/woaixiaotimo/img/master/20181207154502.png)

